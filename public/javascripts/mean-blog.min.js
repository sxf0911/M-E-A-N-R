"use strict";var configs=angular.module("mean.configs",[]);configs.constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),configs.constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),configs.constant("DOM_EVENTS",{onclick:"onclick",onscroll:"onscroll",onchange:"onchange",click:"click",scroll:"scroll",change:"change"}),configs.constant("CUSTOM_EVENTS",{loadMore:"load-more",loading:"loading",loaded:"loaded",loadOver:"load-over",readFilesSuccess:"read-files-success",uploadFilesSuccess:"upload-files-success",blogPreviewOpen:"blog-preview-open",blogPreviewClose:"blog-preview-close"});var services=angular.module("mean.services",["ngResource","mean.configs"]);services.factory("AuthInterceptor",["$rootScope","$q","AUTH_EVENTS",function(a,b,c){return{responseError:function(d){return a.$broadcast({401:c.notAuthenticated,403:c.notAuthorized,419:c.sessionTimeout,440:c.sessionTimeout}[d.status],d),b.reject(d)}}}]),services.service("Session",function(){return this.create=function(a,b,c){this.id=a,this.userId=b,this.userRole=c},this.destroy=function(){this.id=null,this.userId=null,this.userRole=null},this}),services.factory("AuthService",["$http","Session",function(a,b){var c={};return c.login=function(c){return a.post("/auth/login",c).then(function(a){var c=a.data.data;return b.create(c.user._id,c.user._id,c.user.role),c})},c.isAuthenticated=function(){return!!b.userId},c.isAuthorized=function(a){return angular.isArray(a)||(a=[a]),c.isAuthenticated()&&-1!==a.indexOf(b.userRole)},c}]),services.factory("Post",["$resource",function(a){return a("/posts/:id",{id:"@_id"},{update:{method:"PUT"}})}]),services.factory("MultiPostLoader",["Post","$q",function(a,b){return function(c){var d=b.defer();return a.query(c,function(a){d.resolve(a)},function(){d.reject("Unable to fetch posts")}),d.promise}}]),services.factory("PostLoader",["Post","$route","$q",function(a,b,c){return function(){var d=c.defer();return a.get({id:b.current.params.postId},function(a){d.resolve(a)},function(){d.reject("Unable to fetch post "+b.current.params.postId)}),d.promise}}]),services.factory("fileReader",["$q",function(a){var b=function(a,b,c){return function(){c.$apply(function(){b.resolve(a.result)})}},c=function(a,b,c){return function(){c.$apply(function(){b.reject(a.result)})}},d=function(a,d){var e=new FileReader;return e.onload=b(e,a,d),e.onerror=c(e,a,d),e},e=function(b,c){var e=a.defer(),f=d(e,c);return f.readAsDataURL(b),e.promise};return{readAsDataUrl:e}}]),services.service("fileUpload",["$http",function(a){this.uploadToUrl=function(b,c){var d=new FormData;angular.forEach(c,function(a,b){d.append(b,a)});var e={method:"POST",url:b,data:d,headers:{"Content-Type":void 0},transformRequest:angular.identity};return a(e)}}]);var directives=angular.module("mean.directives",["mean.configs"]);directives.directive("pwCheck",[function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){var e=b.inheritedData("$formController")[c.pwCheck];d.$parsers.push(function(a){return d.$setValidity("pwconfirm",a===e.$viewValue),a}),e.$parsers.push(function(a){return d.$setValidity("pwconfirm",a===d.$viewValue),a})}}}]),directives.directive("ensureUnique",function($http){return{restrict:"A",require:"ngModel",link:function(scope,elem,attrs,ctrl){scope.$watch(attrs.ngModel,function(){var data={},field=attrs.ensureUnique,index=field.indexOf("."),value={};index>-1?(data.model=field.substring(0,index),data.field=field.substring(index+1)):(data.model="user",data.field=field),value[data.field]=eval("scope."+attrs.ngModel),data.value=value,$http({method:"POST",url:"/api/checkUnique",data:data}).success(function(a,b,c,d){ctrl.$setValidity("unique",a.isUnique)}).error(function(a,b,c,d){ctrl.$setValidity("unique",!1)})})}}}),directives.directive("authDialog",["AUTH_EVENTS",function(a){return{restrict:"A",template:'<div class="overlay slide-down" ng-if="visible"><article ng-include="\'/auth/login\'" ng-show="toggle" class="flip-in" ng-controller="LoginCtrl"></article><article ng-include="\'/auth/register\'" ng-show="!toggle" class="flip-in" ng-controller="RegisterCtrl"></article><nav class="slideshow"><a ng-click="closeDialog()" class="nav-close"><span class="icon-cancel"></span></a><a ng-click="toggle=!toggle" class="nav-login"><span class="icon-login"></span></a></nav></div>',link:function(b){b.visible=!1,b.toggle=!0;var c=function(a,c){b.visible=!0,"login"===c?b.toggle=!0:b.toggle=!1},d=function(){b.visible=!1};b.closeDialog=d,b.$on(a.notAuthenticated,c),b.$on(a.sessionTimeout,c),b.$on(a.loginSuccess,d)}}}]),directives.directive("blogDialog",["CUSTOM_EVENTS","$sce",function(a,b){return{restrict:"A",template:'<div class="overlay slide-right blog-preview-dialog" ng-show="visible"><section class="container" ng-bind-html="previewContent"></section><nav class="slideshow"><a ng-click="closeDialog()" class="nav-close"><span class="icon-eye-off"></span></a></nav></div>',link:function(c){c.visible=!1;var d=function(a,d){c.visible=!0,c.post.content&&(c.previewContent=b.trustAsHtml(markdown.toHTML(c.post.content)))},e=function(){c.visible=!1};c.closeDialog=e,c.$on(a.blogPreviewOpen,d),c.$on(a.blogPreviewClose,e)}}}]),directives.directive("markDown",["$sce",function(a){return{restrict:"A",link:function(b){b.post.content&&(b.previewContent=a.trustAsHtml(markdown.toHTML(b.post.content)))}}}]),directives.directive("menuLink",["$window","DOM_EVENTS",function(a,b){return{restrict:"A",link:function(c,d,e){var f=d[0];f[b.onclick]=function(b){var c="active";b.preventDefault(),a.document.getElementById("layout").classList.toggle(c),a.document.getElementById("menu").classList.toggle(c),this.classList.toggle(c)}}}}]),directives.directive("whenScrolled",["DOM_EVENTS","CUSTOM_EVENTS","$window",function(a,b,c){return{restrict:"A",link:function(d,e,f){function g(){var a=0,b=0,c=Math.max(j.scrollHeight,i.scrollHeight)||0;return i&&i.scrollTop?a=i.scrollTop:j&&(a=j.scrollTop),b=j.clientHeight&&i.clientHeight?j.clientHeight<i.clientHeight?j.clientHeight:i.clientHeight:j.clientHeight>i.clientHeight?j.clientHeight:i.clientHeight,a+b>=c?!0:!1}var h=e[0],i=c.document.documentElement,j=c.document.body,k=function(){g()&&d.$broadcast(b.loadMore)};h[a.onscroll]=k,d.$on(b.loading,function(){h[a.scroll]=null}),d.$on(b.loaded,function(){h[a.scroll]=k})}}}]),directives.directive("scrollTo",["$window",function(a){return{restrict:"A",link:function(b,c,d){var e=a.document.documentElement,f=a.document.body;b.scrollTo=function(a){if(0===a)f.scrollTop=0;else if(-1===a){var b=Math.max(f.scrollHeight,e.scrollHeight)||0,c=0;c=f.clientHeight&&e.clientHeight?f.clientHeight<e.clientHeight?f.clientHeight:e.clientHeight:f.clientHeight>e.clientHeight?f.clientHeight:e.clientHeight,f.scrollTop=b-c}}}}}]),directives.directive("fileModel",["$parse","DOM_EVENTS",function(a,b){return{restrict:"A",scope:!1,link:function(c,d,e){var f={},g=e.fileModel,h=a("files"),i=h.assign;d[0][b.onchange]=function(a){c.$apply(function(){i(c,d[0].files)}),"readAndUpload"==g&&c.readFiles(f),c.uploadFiles(f)}}}}]),directives.directive("focus",function(){return{link:function(a,b,c){b[0].focus()}}});var app=angular.module("mean",["ngRoute","ngAnimate","mean.directives","mean.services","mean.configs"]);app.config(["$routeProvider","$locationProvider","$httpProvider","USER_ROLES",function(a,b,c,d){a.when("/about",{templateUrl:"/about"}).when("/contact",{templateUrl:"/contact"}).when("/auth/restricted",{templateUrl:"/auth/restricted",data:{authorizedRoles:[d.admin,d.editor,d.guest]}}).when("/blog",{controller:"BlogListCtrl",resolve:{posts:["MultiPostLoader",function(a){return function(b){return a(b)}}]},templateUrl:"/blog/index"}).when("/blog/show/:postId",{controller:"BlogShowCtrl",resolve:{post:["PostLoader",function(a){return a()}]},templateUrl:"/blog/show"}).when("/blog/create",{controller:"BlogCreateCtrl",templateUrl:"/blog/create",data:{authorizedRoles:[d.admin,d.editor]}}).when("/blog/edit/:postId",{controller:"BlogEditCtrl",resolve:{post:["PostLoader",function(a){return a()}]},templateUrl:"/blog/edit",data:{authorizedRoles:[d.admin,d.editor]}}).otherwise({redirectTo:"/blog"}),c.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]),app.run(["$rootScope","$location","AuthService","AUTH_EVENTS",function(a,b,c,d){a.$on("$routeChangeStart",function(b,e,f){NProgress.start();var g=e.$$route?e.$$route.data:null;if(g){var h=g.authorizedRoles;c.isAuthorized(h)||(b.preventDefault(),NProgress.done(),c.isAuthenticated()?(a.$broadcast(d.notAuthorized),console.log("user is not allowed")):a.$broadcast(d.notAuthenticated,"login"))}}),a.$on("$routeChangeSuccess",function(a,b,c){NProgress.done()}),a.$on("$routeChangeError",function(a,b,c){NProgress.done()})}]),app.controller("ApplicationController",["$scope","USER_ROLES","AuthService","Session","$window","AUTH_EVENTS","CUSTOM_EVENTS",function(a,b,c,d,e,f,g){a.currentUser=null,a.BlogCount=null,a.userRoles=b,a.isAuthorized=c.isAuthorized,a.currentRoutePath="/blog";var h=e.clientUser;a.$on("$routeChangeSuccess",function(b,c,d){c.$$route&&(a.currentRoutePath=c.$$route.originalPath)}),a.authDialog=function(b){a.$broadcast(f.notAuthenticated,b)},a.blogDialog=function(){a.$broadcast(g.blogPreviewOpen)},a.setCurrentUser=function(b){a.currentUser=b},a.setBlogCount=function(b){a.BlogCount=b},h&&(d.create(h._id,h._id,h.role),a.setCurrentUser(h))}]),app.controller("LoginCtrl",["$scope","$rootScope","$location","$window","AuthService","AUTH_EVENTS",function(a,b,c,d,e,f){a.credentials={username:"",password:""},a.login=function(c){e.login(c).then(function(c){b.$broadcast(f.loginSuccess,c),a.setCurrentUser(c.user)},function(a){b.$broadcast(f.loginFailed,a),console.log(a)})}}]),app.controller("RegisterCtrl",["$scope","$location","$http","$rootScope",function(a,b,c,d){a.user={username:"",password:"",password_confirmation:"",email:""},a.register=function(){c.post("/auth/register",{username:a.user.username,password:a.user.password,password_confirmation:a.user.password_confirmation,email:a.user.email}).success(function(a){d.$broadcast(AUTH_EVENTS.loginSuccess,a)}).error(function(a){console.log(data)})}}]),app.controller("BlogListCtrl",["$scope","posts","CUSTOM_EVENTS",function(a,b,c){function d(c){return b(c).then(function(b){a.posts=a.posts.concat(b),a.setBlogCount(a.posts.length)},function(a){})}a.posts=[],d({skip:0,limit:12}),a.$on(c.loadMore,function(b){a.$emit(c.loading),NProgress.start(),setTimeout(function(){d({skip:a.posts.length,limit:12}).then(function(){a.$emit(c.loaded),NProgress.done()})},1e3)})}]),app.controller("BlogCreateCtrl",["$scope","$location","Post","CUSTOM_EVENTS",function(a,b,c,d){a.post=new c,a.imageDataUrlList=[],a.$on(d.readFilesSuccess,function(b,c){a.imageDataUrlList=a.imageDataUrlList.concat(c)}),a.$on(d.uploadFilesSuccess,function(b,c){var d="\n";angular.forEach(c,function(a,b){d+="![no image, can talk]("+a+' "by Cai")'}),a.post.content=a.post.content?a.post.content+d:d,a.post.imgList=angular.isArray(a.post.imgList)?a.post.imgList.concat(c):c}),a.save=function(){a.post.user=a.currentUser,a.post.$save(function(a){var c=a.data;b.path("/blog/show/"+c._id)})}}]),app.controller("BlogShowCtrl",["$scope","$location","post",function(a,b,c){a.post=c.data}]),app.controller("BlogEditCtrl",["$scope","$location","post","Post","CUSTOM_EVENTS",function(a,b,c,d,e){a.post=new d(c.data),a.imageDataUrlList=[],a.$on(e.readFilesSuccess,function(b,c){a.imageDataUrlList=a.imageDataUrlList.concat(c)}),a.$on(e.uploadFilesSuccess,function(b,c){var d="\n";angular.forEach(c,function(a,b){d+="![no image, can talk]("+a+' "by Cai")'}),a.post.content=a.post.content?a.post.content+d:d,a.post.imgList=angular.isArray(a.post.imgList)?a.post.imgList.concat(c):c});var f=c.data._id;a.update=function(){a.post.$update(function(a){a.data;b.path("/blog/show/"+f)})},a.remove=function(){1==confirm("Are you sure to delete it ? ")&&a.post.$delete(function(){b.path("/blog")})}}]),app.controller("UploaderController",["$scope","fileReader","fileUpload","$rootScope","CUSTOM_EVENTS",function(a,b,c,d,e){a.readFiles=function(c){var f=[],g=a.files;angular.forEach(g,function(g,h,i){b.readAsDataUrl(g,a).then(function(a){f.push(a),i.length-1==h&&(d.$broadcast(e.readFilesSuccess,f),c.success&&c.success())},function(a){c.error&&c.error()})})},a.uploadFinished=function(a,b){console.log("We just finished uploading this baby...")},a.uploadFiles=function(b){var f,g=a.files;c.uploadToUrl("/posts/upload",g).then(function(a){var c=a.data;f=c.data,d.$broadcast(e.uploadFilesSuccess,f),b.success&&b.success()},function(){console.log("error"),b.error&&b.error()})}}]),app.controller("IngredientsCtrl",["$scope",function(a){a.removeImageDataUrl=function(b){a.imageDataUrlList.splice(b,1),a.post.imgList.splice(b,1)}}]);